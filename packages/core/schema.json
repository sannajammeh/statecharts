{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://statecharts.sh/schema.json",
  "title": "ExportedChart",
  "description": "JSON Schema for statechart export format",
  "type": "object",
  "required": ["version", "id", "initial", "context", "states"],
  "properties": {
    "version": {
      "const": 1,
      "description": "Schema version for forward compatibility"
    },
    "id": {
      "type": "string",
      "description": "Chart identifier"
    },
    "initial": {
      "type": "string",
      "description": "Initial state name"
    },
    "context": {
      "description": "Initial context value"
    },
    "states": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/ExportedStateNode"
      },
      "description": "State tree structure"
    }
  },
  "$defs": {
    "ExportedTransition": {
      "type": "object",
      "required": ["guard", "actions"],
      "properties": {
        "target": {
          "type": "string",
          "description": "Target state name"
        },
        "guard": {
          "type": ["string", "null"],
          "description": "Guard function name or null"
        },
        "actions": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Action function names"
        }
      }
    },
    "TransitionOrArray": {
      "oneOf": [
        { "$ref": "#/$defs/ExportedTransition" },
        {
          "type": "array",
          "items": { "$ref": "#/$defs/ExportedTransition" }
        }
      ]
    },
    "ParallelRegion": {
      "type": "object",
      "required": ["initial", "states"],
      "properties": {
        "initial": {
          "type": "string"
        },
        "states": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/ExportedStateNode"
          }
        }
      }
    },
    "ExportedStateNode": {
      "type": "object",
      "required": ["entry", "exit", "on"],
      "properties": {
        "entry": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Entry action names"
        },
        "exit": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Exit action names"
        },
        "on": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/TransitionOrArray"
          },
          "description": "Event transitions"
        },
        "after": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/TransitionOrArray"
          },
          "description": "Delayed transitions keyed by milliseconds"
        },
        "invoke": {
          "type": ["string", "null"],
          "description": "Invoked service function name"
        },
        "onDone": {
          "$ref": "#/$defs/TransitionOrArray",
          "description": "Transition on invoke completion"
        },
        "onError": {
          "$ref": "#/$defs/TransitionOrArray",
          "description": "Transition on invoke error"
        },
        "initial": {
          "type": "string",
          "description": "Initial child state for compound states"
        },
        "states": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/ExportedStateNode"
          },
          "description": "Nested state nodes"
        },
        "parallel": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/ParallelRegion"
          },
          "description": "Parallel state regions"
        },
        "final": {
          "type": "boolean",
          "description": "Whether this is a final state"
        }
      }
    }
  }
}
